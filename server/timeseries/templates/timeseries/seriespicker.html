<!-- SeriesPicker.html -->
{# this is a drop-in file meant to be {% include %}ed, not extended! #}
<style type="text/css">
	.header_options{
		width:auto;
		float:left;
		margin-right:10px;
	}
	
	/* initially hide things */
	div.params_wrapper{
		display:none;
	}

	.dynamic-highchart{
		width:70%;
	}

	.check_label{
		cursor:pointer;
	}
</style>
<div id="query_builder" class="well">
	<!-- SYSTEM DROP-DOWN MENU -->
	<div class="system_select">
		<h3>Select System</h3>
		<select class="system_select"><!-- drop down menu -->
			{% for sys, subs in systems.iteritems %}
			{% for subsys, specs in subs.iteritems %}
			<option data-subsysid="{{ specs.id }}_params" data-sys="{{ sys }}" data-sub="{{ subsys }}">{{ sys }} - {{ subsys }}</option>
			{% endfor %}
			{% endfor %}
		</select>
	</div>
	{% for sys, subs in systems.iteritems %}
	{% for subsys, specs in subs.iteritems %}
	{# EACH OF THE SUBSYSTEMS' PARAMETERS (CHECKBOXES) #}
	<div class="params_wrapper" id="{{ specs.id }}_params">
	{% if specs.selection|length > 0 %}
		<div class="header_select">
			<h3>Select Series</h3>
		{% for name, options in specs.selection.iteritems %}
			<div class="header_options">
				<h4>{{ name }}</h4>
				<label class="check_label"><input type="checkbox" class="check_all" />&nbsp;(select all)</label><br />
			{% for opt in options %}
				<label class="check_label"><input type="checkbox" class="check_option" data-headername="{{ name }}" data-colname="{{ opt }}" />&nbsp;{{ opt }}</label><br />
			{% endfor %}
			</div>
		{% endfor %}
		</div>
	{% endif %}
		<div class="column_select" id="columns_{{ specs.id }}">
			<h3>Select Columns</h3>
			<label class="check_label"><input type="checkbox" class="check_all" id="{{ specs.id }}_col_check_all" />&nbsp;(select all)</label><br />
		{% for col in specs.numeric %}
			<label class="check_label"><input type="checkbox" class="check_option" data-colname="{{ col }}" id="check_{{ col }}" />&nbsp;{{ col }}</label><br />
		{% endfor %}
		</div>
	</div>
	{% endfor %}
	{% endfor %}
</div>
<script>
	$(function(){
		// swap out sub-options when system is changed
		$("select.system_select").change(function(){
			var target_show_id = $(this).find(':selected').data("subsysid");
			var target_show_div = $("div#"+target_show_id);
			$(".params_wrapper").hide();
			target_show_div.show();
		});
		$("select.system_select").change(); // call it immediately so that the initial system's parameters appear on the screen

		// this handles when the "(select all)" options are checked
		$(".check_all").change(function(){
			// step up to the parent div, then set the checked-ness of all of its children
			// (siblings(".check_option") could have been used if it weren't for the <label><input /> text</label> construct)
			$(this).closest("div").find("input.check_option").prop('checked', this.checked);
		});
	});

	// extend the Commons object with a seriespicker function, which returns
	// a series object in the format used by the api (see timeseries.helpers.series_filter)
	Commons.seriespicker = function(){
		var sys = $("select.system_select").find(':selected').data("sys");
		var subsys = $("select.system_select").find(':selected').data("sub");
		var params_id = $("select.system_select").find(":selected").data("subsysid");
		var params_div = $("div#"+params_id);


		var columns = [];
		params_div.find("div.column_select input.check_option").each(function(idx, elem){
			if(elem.checked){
				columns.push($(elem).data("colname"));
			}
		});

		var headers = {};
		params_div.find("div.header_options").find("input.check_option").each(function(idx, elem){
			if(elem.checked){
				var header_name = $(elem).data("headername");
				if(!headers.hasOwnProperty(header_name))
					headers[header_name] = [$(elem).data("colname")];
				else
					headers[header_name].push($(elem).data("colname"));
			}
		});

		retobj = {};
		retobj[sys] = {};
		retobj[sys][subsys] = { 'columns' : columns, 'series' : headers};
		return retobj;
	}
</script>
<!-- end SeriesPicker.html -->
